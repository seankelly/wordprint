#!/usr/bin/env python
"""
Create word fingerprints from CSV dumps of the comments table of a
Wordpress site.
"""

import csv
import re
import sys
from collections import defaultdict

valid_words = set()

def usage():
    print "usage: %s CSV ..." % (sys.argv[0])
    sys.exit(0)

def load_dictionary():
    global valid_words
    with open('/usr/share/dict/words', 'rb') as f:
        for word in f:
            w = word.lower()
            valid_words.add(w)

def read_comments(csv_file):
    # Field 3: user
    # Field 9: text
    f = open(csv_file, 'rb')
    c = csv.reader(f, delimiter=',', doublequote=False, escapechar='\\')
    for l in c:
        yield l[2], l[8]

def generate_wordprint(comments_csv):
    # This dict maps word => set(users).
    # When a word becomes too common, delete it and move it to common_words.
    wordprint = defaultdict(lambda: set())
    # When a word becomes too common, move it to the common_words set. This
    # will be checked first before adding words to wordprint.
    common_words = set()
    # User dict to map user => word => count.
    user_wordprint = defaultdict(
        lambda: defaultdict(
            lambda: 0))
    find_words = re.compile('(\w+)')
    global valid_words
    for user, text in read_comments(comments_csv):
        # Convert to lowercase.
        lower_text = text.lower()
        # Grab all 'words'. Using the regex understanding of what a word is.
        words = find_words.findall(lower_text)
        for w in words:
            if w not in valid_words:
                continue
            user_wordprint[user][w] += 1
            if w in common_words:
                continue
            wordprint[w].add(user)
            if len(wordprint[w]) > 2:
                common_words.add(w)
                del wordprint[w]
    summarize_wordprint(user_wordprint, wordprint)

def summarize_wordprint(user_wordprint, wordprint):
    def sort_words(user):
        # Given a user, return a lambda to sort the unique words in descending
        # order.
        u = user_wordprint[user]
        return lambda a,b: cmp(u[b], u[a])
    unique_words = set(wordprint.keys())
    for user in user_wordprint:
        user_words = set(user_wordprint[user].keys())
        user_unique = unique_words & user_words
        user_print = sorted(user_unique, sort_words(user))
        # If no unique words, skip this user.
        if len(user_print) == 0:
            continue
        print user, user_print[0], user_wordprint[user][user_print[0]]

if __name__ == '__main__':
    if len(sys.argv) == 1:
        usage()

    load_dictionary()
    for comments_csv in sys.argv[1:]:
        generate_wordprint(comments_csv)
